@using TinyLogic_ok.Models.CourseModels
@model PythonCourseVM

<div class="mx-auto mt-10 max-w-5xl">

    <h1 class="text-4xl font-bold text-indigo-600">@Model.Course.CourseName</h1>
    <p class="mb-6 text-gray-600">@Model.Course.Description</p>

    <div class="grid grid-cols-4 gap-6">

       
        <div class="col-span-1 rounded-lg bg-white p-4 shadow">
            <h2 class="mb-3 text-xl font-semibold">Lecții</h2>

            <ul class="space-y-2">
                @foreach (var lesson in Model.Lessons)
                {
                    var isSelected = Model.SelectedLesson?.IdLesson == lesson.IdLesson;
                    var isLocked = !Model.CompletedLessonIds.Contains(lesson.IdLesson - 1) && lesson.OrderIndex != 1;

                    <li>
                        @if (!isLocked)
                        {
                            <a href="/Courses/PythonCourse?courseId=@Model.Course.CourseId&lessonId=@lesson.IdLesson"
                               class="flex items-center justify-between rounded-lg p-2 @(isSelected ? "bg-indigo-100" : "hover:bg-gray-100")">
                                <span>@lesson.LessonName</span>

                                @if (Model.CompletedLessonIds.Contains(lesson.IdLesson))
                                {
                                    <span class="ml-2 font-bold text-green-600">✔</span>
                                }
                            </a>
                        }
                        else
                        {
                            <div class="flex cursor-not-allowed items-center justify-between rounded-lg bg-gray-200 p-2 opacity-60">
                                <span>@lesson.LessonName</span>
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                        }
                    </li>
                }
            </ul>
        </div>

      
        <div class="col-span-3 rounded-lg bg-white p-6 shadow">

            @if (Model.SelectedLesson == null)
            {
                <p>Selectează o lecție din meniu.</p>
            }
            else
            {
                <h2 class="mb-4 text-3xl font-bold">@Model.ParsedContent.Title</h2>

                @foreach (var sec in Model.ParsedContent.Sections)
                {
                    <h3 class="mt-4 text-xl font-semibold">@sec.Heading</h3>
                    <p class="text-gray-700">@sec.Text</p>
                }

                @if (Model.SelectedLesson.OrderIndex > Model.HighestCompletedOrder + 1)
                {
                    <div class="mt-6 font-semibold text-red-600">
                        Această lecție este blocată. Finalizează întâi lecția anterioară. 🔒
                    </div>
                }
                else
                {
                    @if (!Model.IsSelectedLessonCompleted)
                    {
                        <button onclick="openCodeModal()"
                                class="mt-6 rounded-xl bg-blue-600 px-6 py-3 font-semibold text-white hover:bg-blue-700">
                            Scrie codul pentru a continua ▶️
                        </button>
                    }
                    else
                    {
                        <button disabled
                                class="mt-6 cursor-not-allowed rounded-xl bg-green-600 px-6 py-3 font-semibold text-white opacity-70">
                            Lecția finalizată ✔
                        </button>
                    }
                }
            }

        </div>
    </div>

    
    @if (Model.SelectedLesson != null
        && Model.ParsedContent != null
        && !Model.IsSelectedLessonCompleted
        && Model.SelectedLesson.OrderIndex <= Model.HighestCompletedOrder + 1)
    {
        <div id="codeModal"
             class="fixed inset-0 flex hidden items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">

            <div class="w-11/12 max-w-3xl rounded-2xl bg-white p-6 shadow-xl">

                <h2 class="mb-4 text-2xl font-bold">Exercițiu obligatoriu</h2>

                <p class="mb-4 text-gray-700">@Model.ParsedContent.Exercise.Description</p>

             
                <div id="editorContainer" style="height: 300px; width: 100%; border:1px solid #ccc;"></div>
                <input type="hidden" id="codeInput" />

                <div id="resultBox" class="mt-3 hidden rounded-lg p-3"></div>

                <div class="mt-4 flex justify-end">
                    <button onclick="closeCodeModal()"
                            class="mr-2 rounded-lg border px-4 py-2">
                        Închide
                    </button>

                    <button onclick="checkCode(@Model.SelectedLesson.IdLesson)"
                            class="rounded-lg bg-green-600 px-6 py-2 font-semibold text-white hover:bg-green-700">
                        Verifică răspunsul ✔️
                    </button>
                </div>

            </div>
        </div>
    }

</div>


<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<script>
    let editor;

    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});

    require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(document.getElementById('editorContainer'), {
            value: "",
            language: "python",
            theme: "vs-dark",
            fontSize: 16,
            minimap: { enabled: false },

            
            tabSize: 4,
            insertSpaces: true,
            detectIndentation: false,
            automaticLayout: true,
            formatOnPaste: true,
            formatOnType: true
        });
    });

    function openCodeModal() {
        document.getElementById("codeModal").classList.remove("hidden");
        setTimeout(() => editor.layout(), 200);
    }

    function closeCodeModal() {
        document.getElementById("codeModal").classList.add("hidden");
    }

    async function checkCode(lessonId) {

        const code = editor.getValue();

        const response = await fetch('/Lessons/CheckPython', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, lessonId: lessonId })
        });

        const data = await response.json();
        const resultBox = document.getElementById("resultBox");
        resultBox.classList.remove("hidden");
        resultBox.classList.remove("bg-green-100", "text-green-700", "bg-red-100", "text-red-700");

        if (data.success) {
            resultBox.classList.add("bg-green-100", "text-green-700");
            resultBox.textContent = "Corect! Lecția a fost marcată ca finalizată. 🎉";

            setTimeout(() => location.reload(), 1500);
        } else {
            resultBox.classList.add("bg-red-100", "text-red-700");
            resultBox.innerHTML = "Răspuns greșit:<br>" + data.message;
        }
    }
</script>