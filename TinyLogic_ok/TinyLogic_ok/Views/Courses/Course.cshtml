@using TinyLogic_ok.Models.CourseModels
@model CourseVM

@{
    var lang = Model?.Course?.Language ?? "python";
    var isBlocks = lang == "blocks";
}

<div class="mx-auto mt-10 max-w-5xl">

    <h1 class="text-4xl font-bold text-indigo-600">@Model.Course.CourseName</h1>
    <p class="mb-6 text-gray-600">@Model.Course.Description</p>

    <div class="grid grid-cols-4 gap-6">

        <div class="col-span-1 rounded-lg bg-white p-4 shadow">
            <h2 class="mb-3 text-xl font-semibold">Lecții</h2>

            <ul class="space-y-2">
                @foreach (var lesson in Model.Lessons)
                {
                    var isSelected = Model.SelectedLesson?.IdLesson == lesson.IdLesson;
                    var isLocked = lesson.OrderIndex > Model.HighestCompletedOrder + 1;

                    <li>
                        @if (!isLocked)
                        {
                            <a href="/Courses/Course?courseId=@Model.Course.CourseId&lessonId=@lesson.IdLesson"
                               class="flex items-center justify-between rounded-lg p-2 @(isSelected ? "bg-indigo-100" : "hover:bg-gray-100")">
                                <span>@lesson.LessonName</span>

                                @if (Model.CompletedLessonIds.Contains(lesson.IdLesson))
                                {
                                    <span class="ml-2 font-bold text-green-600">✔</span>
                                }
                            </a>
                        }
                        else
                        {
                            <div class="flex cursor-not-allowed items-center justify-between rounded-lg bg-gray-200 p-2 opacity-60">
                                <span>@lesson.LessonName</span>
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                        }
                    </li>
                }
            </ul>
        </div>

        <div class="col-span-3 rounded-lg bg-white p-6 shadow">
            @if (Model.SelectedLesson == null)
            {
                <p>Selectează o lecție.</p>
            }
            else
            {
                <h2 class="mb-2 text-3xl font-bold">@Model.ParsedContent.Title</h2>

                @foreach (var sec in Model.ParsedContent.Sections)
                {
                    <h3 class="mt-4 text-xl font-semibold">@sec.Heading</h3>
                    <p class="text-gray-700">@sec.Text</p>
                }

                @if (!Model.IsSelectedLessonCompleted)
                {
                    <button onclick="openCodeModal()"
                            class="mt-6 rounded-xl bg-blue-600 px-6 py-3 font-semibold text-white hover:bg-blue-700">
                        Rezolvă exercițiul ▶️
                    </button>
                }
                else
                {
                    <button disabled
                            class="mt-6 cursor-not-allowed rounded-xl bg-green-600 px-6 py-3 font-semibold text-white opacity-70">
                        Lecție finalizată ✔
                    </button>
                }
            }
        </div>
    </div>
</div>


<div id="codeModal"
     class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">

    <div class="w-11/12 max-w-3xl rounded-2xl bg-white p-6 shadow-xl">

        <h2 class="mb-4 text-2xl font-bold">Exercițiu</h2>
        <p class="mb-4">@Model?.ParsedContent?.Exercise?.Description</p>

       
        <div id="editorContainer"
             style="height:300px;width:100%;border:1px solid #ccc;display:none;"></div>

    
        <div id="blocklyContainer"
             style="height:300px;width:100%;border:1px solid #ccc;display:none;"></div>

     
        <xml id="blocklyToolbox" style="display:none">

            <category name="Start" colour="120">
                <block type="tl_on_start"></block>
            </category>

            <category name="Mișcare" colour="210">
                <block type="tl_move"></block>
                <block type="tl_turn_right"></block>
            </category>

            <category name="Control" colour="180">
                <block type="controls_repeat_ext">
                    <value name="TIMES">
                        <shadow type="math_number">
                            <field name="NUM">3</field>
                        </shadow>
                    </value>
                </block>
            </category>

            <category name="Variabile" colour="330">
                <block type="tl_set_var"></block>
                <block type="tl_change_var"></block>
            </category>

        </xml>



        <div id="resultBox" class="mt-3 hidden rounded-lg p-3"></div>

        <div class="mt-4 flex justify-end">
            <button onclick="closeCodeModal()" class="mr-2 rounded-lg border px-4 py-2">
                Închide
            </button>
            <button onclick="checkCode(@(Model.SelectedLesson?.IdLesson ?? 0))"
                    class="rounded-lg bg-green-600 px-6 py-2 font-semibold text-white hover:bg-green-700">
                Verifică ✔
            </button>
        </div>
    </div>
</div>

@if (!isBlocks)
{
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
}
else
{
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/en.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>

    <script src="~/js/blockly/blockly-minimal.js"></script>
   
}

<script>
    let editor = null;
    let workspace = null;

    const language = "@lang"; // "python" / "c" / "blocks"

    function openCodeModal() {
        const modal = document.getElementById("codeModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");

        if (language === "blocks") {
            initBlockly();
        } else {
            initMonaco();
        }
    }

    function closeCodeModal() {
        const modal = document.getElementById("codeModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    function initMonaco() {
        document.getElementById("editorContainer").style.display = "block";
        document.getElementById("blocklyContainer").style.display = "none";

        if (editor) {
            setTimeout(() => editor.layout(), 50);
            return;
        }

        if (typeof require === "undefined") {
            console.error("Monaco loader.js nu este încărcat (require undefined).");
            return;
        }

        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
        require(["vs/editor/editor.main"], function () {
            editor = monaco.editor.create(document.getElementById("editorContainer"), {
                value: "",
                language: language,
                theme: "vs-dark",
                automaticLayout: true,
                minimap: { enabled: false }
            });

            setTimeout(() => editor.layout(), 50);
        });
    }

    function initBlockly() {
        document.getElementById("editorContainer").style.display = "none";
        document.getElementById("blocklyContainer").style.display = "block";

        if (typeof Blockly === "undefined") {
            console.error("Blockly NU este încărcat. Verifică scripturile Blockly din pagină.");
            return;
        }

        if (!workspace) {
            workspace = Blockly.inject("blocklyContainer", {
                toolbox: document.getElementById("blocklyToolbox"),
                trashcan: true,
                scrollbars: true
            });
        }

        setTimeout(() => {
            Blockly.svgResize(workspace);
        }, 80);
    }

    async function checkCode(lessonId) {
    let code = "";

    if (language === "blocks") {
        if (!workspace) {
            alert("Workspace Blockly nu este inițializat!");
            return;
        }

        const topBlocks = workspace.getTopBlocks(false);
        const hasStart = topBlocks.some(b => b.type === "tl_on_start");

        if (!hasStart) {
            alert("❌ Programul trebuie să înceapă cu blocul „Când apeși pe 🚀”!");
            return;
        }

        code = window.getTinyLogicCode(workspace);
    }
    else {
        if (!editor) {
            alert("Editorul Monaco nu este inițializat!");
            return;
        }
        code = editor.getValue();
    }

    const endpoint =
        language === "c" ? "/Lessons/CheckC" :
        language === "blocks" ? "/Lessons/CheckBlocks" :
        "/Lessons/CheckPython";

    const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code, lessonId })
    });

    const data = await response.json();
    const box = document.getElementById("resultBox");

    box.classList.remove("hidden");
    box.textContent = data.success ? "✔ Corect!" : (data.message || "Greșit!");

    box.className = data.success
        ? "mt-3 rounded-lg p-3 bg-green-100 text-green-700"
        : "mt-3 rounded-lg p-3 bg-red-100 text-red-700";

    if (data.success) setTimeout(() => location.reload(), 1200);
}
</script>
